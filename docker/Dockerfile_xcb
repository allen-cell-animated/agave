### Build image ###
FROM nvidia/opengl:1.2-glvnd-runtime-ubuntu22.04
# FROM nvidia/cuda:12.6.1-runtime-ubuntu22.04 AS build
# FROM nvidia/cuda:12.6.1-devel-ubuntu24.04 AS build

# install dependencies
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    apt-utils \
    build-essential \
    software-properties-common \
    git \
    wget \
    libegl1 \
    xvfb \
    xauth \
    libspdlog-dev \
    libglm-dev \
    libtiff-dev \
    libzstd-dev \
    nasm \
    libglvnd0 \
    libgl1 \
    libglx0 libegl1 libgles2 \
    libxkbcommon-x11-0 \
    libglvnd-dev \
    libx11-dev libxext-dev libxrender-dev libxrandr-dev libxi-dev \
    libxkbcommon-dev libx11-xcb-dev libxcb1-dev libxcb-glx0-dev \
    libdrm2 libgbm1 \
    && rm -rf /var/lib/apt/lists/*


# graphics deps
# Qt xcb + X11 runtime deps (no dev pkgs)
# Core X11 / XCB core + util family (needed by Qt's libqxcb) / Common Qt runtime deps /
# Helpful for testing/display plumbing
RUN apt-get update && apt-get install -y --no-install-recommends \
    libx11-6 libx11-xcb1 libxext6 libxrender1 libxrandr2 libxi6 \
    libxfixes3 libxinerama1 libxcomposite1 libxcursor1 libxdamage1 \
    libxkbcommon0 libxkbcommon-x11-0 \
    libxcb1 libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
    libxcb-render0 libxcb-render-util0 libxcb-randr0 libxcb-shape0 \
    libxcb-shm0 libxcb-sync1 libxcb-xinerama0 libxcb-xfixes0 libxcb-xinput0 \
    libdbus-1-3 libglib2.0-0 libfreetype6 libfontconfig1 \
    libjpeg-turbo8 libpng16-16 libtiff5 libzstd1 libicu70 \
    libdouble-conversion3 libpcre2-16-0 \
    x11-apps x11-xserver-utils mesa-utils \
    && rm -rf /var/lib/apt/lists/*


# package jail
#libgles2-mesa-dev \
#libgl1-mesa-dev \
#libegl1-mesa-dev \

##### Force Nvidia EGL
# --- GLVND runtime for EGL/GLX/OpenGL (no full Mesa software stack) ---
#RUN apt-get update && apt-get install -y --no-install-recommends \
#    libglvnd0 libgl1 libegl1 libgles2 libglx0 \
# && rm -rf /var/lib/apt/lists/*

# Optional: set defaults so exec shells inherit sensible values
ENV __GLX_VENDOR_LIBRARY_NAME=nvidia
ENV __EGL_VENDOR_LIBRARY_FILENAMES=/usr/share/glvnd/egl_vendor.d/10_nvidia.json
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=graphics,utility,compute
ENV LANG=C.UTF-8
#ENV QT_QPA_PLATFORM=offscreen

# Helpful if NVIDIA libs are mounted under a subdir by the runtime on your distro
ENV LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu/nvidia:${LD_LIBRARY_PATH}
##### End Force Nvidia EGL

#RUN apt-get install -y apt-transport-https ca-certificates gnupg
# HTTPS + GPG tools (no apt-transport-https; gnupg meta replaced by gpg/gpgconf)
# apt supports https by default and installing apt-transport-https will bloat container and cause noise
# minimal base image does not contain gnupg
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates gpg gpgconf dirmngr \
    && rm -rf /var/lib/apt/lists/*


# get a current cmake
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /etc/apt/trusted.gpg.d/kitware.gpg >/dev/null
RUN apt-add-repository 'deb https://apt.kitware.com/ubuntu/ jammy main'
RUN apt-get install kitware-archive-keyring
RUN rm /etc/apt/trusted.gpg.d/kitware.gpg
RUN apt-get update && apt-get install -y cmake

# get python
RUN apt-get install -y python3-pip python3-venv

# get Qt installed
ENV QT_VERSION=6.8.3
RUN pip install aqtinstall #--break-system-packages
RUN aqt install-qt --outputdir /qt linux desktop ${QT_VERSION} -m qtwebsockets qtimageformats
# required for qt offscreen platform plugin
RUN apt-get install -y libfontconfig
ENV QTDIR=/qt/${QT_VERSION}/gcc_64
ENV Qt6_DIR=/qt/${QT_VERSION}/gcc_64

# copy agave project
RUN mkdir /agave
COPY . /agave
RUN rm -rf /agave/build
RUN mkdir /agave/build
WORKDIR /agave

# install submodules
RUN git submodule update --init --recursive

# get ninja
RUN apt-get install -y ninja-build pkg-config

# build agave project
RUN cd ./build && \
    cmake .. -G Ninja \
    -DOpenGL_GL_PREFERENCE=GLVND \
    -DQT_DEBUG_FIND_PACKAGE=ON \
    && cmake --build . --config Release -j 24

# leaving this here to show how to load example data into docker image
# RUN mkdir /agavedata
# RUN cp AICS-11_409.ome.tif /agavedata/
# RUN cp AICS-12_881.ome.tif /agavedata/
# RUN cp AICS-13_319.ome.tif /agavedata/

EXPOSE 1235

COPY docker/docker-entrypoint.sh /usr/local/bin/
RUN ["chmod", "+x", "/usr/local/bin/docker-entrypoint.sh"]
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

#  docker build -t agave_latest -f docker/Dockerfile_xcb .
#  docker run --name docker-agave -p 1235:1235 -d agave_latest
